<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>ğŸ“Š CSVæ”¯å‡ºåˆ†æãƒãƒ£ãƒ¼ãƒˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 50px;
      background: #f5f5f5;
    }
    input, button {
      margin: 10px;
    }
    canvas {
      max-width: 600px;
      margin: auto;
    }
    #commentBox {
      margin-top: 40px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ”¯å‡ºåˆ†æãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆ</h1>
  
  <p>ä»¥ä¸‹ã®åˆ—ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼šday, time, name, cost, genre</p>
  <input accept=".csv" id="csvFile" type="file"/>
  <br/>

  <div class="section">
    <a href="makedata.html">
      <button>ğŸ“„ ãƒ‡ãƒ¼ã‚¿ä½œæˆç”»é¢ã¸</button>
    </a>
  </div>

  <button id="generateBtn">ğŸ“ˆ ãƒãƒ£ãƒ¼ãƒˆã‚’ç”Ÿæˆ</button>
  <button id="generateCommentBtn">ğŸ’¬ ChatGPT åˆ†æã‚’ç”Ÿæˆ</button>

  <div class="section">
    <h2>ğŸ° æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªåˆ¥å††ã‚°ãƒ©ãƒ•ï¼ˆå††ï¼‰</h2>
    <canvas id="pieChart" width="400" height="400"></canvas>
  </div>

  <div class="section">
    <h2>ğŸ“… 1æ—¥ã‚ãŸã‚Šã®å¹³å‡æ”¯å‡ºé‡‘é¡</h2>
    <p id="avgCost">-</p>
  </div>

  <div class="section">
    <h2>ğŸ† æ”¯å‡ºã‚«ãƒ†ã‚´ãƒªãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
    <ul id="rankingList"></ul>
  </div>

  <div class="section">
    <h2>ğŸ“ˆ æœˆåˆ¥æ”¯å‡ºã®æ¨ç§»</h2>
    <canvas id="lineChart" width="600" height="400"></canvas>
  </div>

  <div id="commentBox">ğŸ’¬ ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</div>

  <script>
    let csvData = "";

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");

      const reader = new FileReader();
      reader.onload = function (event) {
        csvData = event.target.result.trim();
      };
      reader.readAsText(file, 'UTF-8');
    });

    document.getElementById('generateBtn').addEventListener('click', function () {
      if (!csvData) return alert("ã¾ãšCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");

      const lines = csvData.split('\n');
      const headers = lines[0].split(',');

      const genreIndex = headers.indexOf('genre');
      const costIndex = headers.indexOf('cost');
      const dayIndex = headers.indexOf('day');
      if (genreIndex === -1 || costIndex === -1 || dayIndex === -1) {
        return alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ 'day', 'genre', 'cost' ã®åˆ—ãŒå¿…è¦ã§ã™");
      }

      const dataMap = {};
      const dayTotal = {};
      const genreTotal = {};
      const monthTotal = {};

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        const genre = row[genreIndex];
        const cost = parseFloat(row[costIndex]);
        const day = row[dayIndex];
        const month = day?.slice(0, 7);
        if (!isNaN(cost) && genre && day) {
          dataMap[genre] = (dataMap[genre] || 0) + cost;
          genreTotal[genre] = (genreTotal[genre] || 0) + cost;
          dayTotal[day] = (dayTotal[day] || 0) + cost;
          monthTotal[month] = (monthTotal[month] || 0) + cost;
        }
      }

      // å††ã‚°ãƒ©ãƒ•
      const sortedEntries = Object.entries(dataMap).sort((a, b) => b[1] - a[1]);
      const labels = sortedEntries.map(entry => entry[0]);
      const values = sortedEntries.map(entry => entry[1]);
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (window.pieChart && typeof window.pieChart.destroy === 'function') window.pieChart.destroy();
      window.pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['red','blue','green','orange','purple','pink','brown','yellow','gray','cyan']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            title: { display: true, text: 'æ”¯å‡ºå††ã‚°ãƒ©ãƒ•ï¼ˆé‡‘é¡é †ï¼‰' }
          }
        }
      });

      // å¹³å‡æ”¯å‡º
      const totalDays = Object.keys(dayTotal).length;
      const totalCost = Object.values(dayTotal).reduce((a, b) => a + b, 0);
      const avg = totalDays > 0 ? (totalCost / totalDays).toFixed(2) : "0";
      document.getElementById("avgCost").innerText = `1æ—¥ã‚ãŸã‚Šã®å¹³å‡æ”¯å‡ºï¼š${avg} å††`;

      // ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      const sortedGenre = Object.entries(genreTotal).sort((a, b) => b[1] - a[1]);
      const rankList = document.getElementById("rankingList");
      rankList.innerHTML = "";
      sortedGenre.forEach(([genre, amount], idx) => {
        const li = document.createElement("li");
        li.textContent = `${idx + 1}ï¼š${genre} - ${Math.round(amount)} å††`;
        rankList.appendChild(li);
      });

      // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•
      const sortedMonths = Object.keys(monthTotal).sort();
      const monthValues = sortedMonths.map(m => monthTotal[m]);
      const lineCtx = document.getElementById("lineChart").getContext("2d");
      if (window.lineChart && typeof window.lineChart.destroy === 'function') window.lineChart.destroy();
      window.lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'æœˆåˆ¥æ”¯å‡ºï¼ˆå††ï¼‰',
            data: monthValues,
            fill: false,
            borderColor: 'blue',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'æœˆåˆ¥æ”¯å‡ºã®æ¨ç§»ã‚°ãƒ©ãƒ•' }
          }
        }
      });
    });

    document.getElementById('generateCommentBtn').addEventListener('click', function () {
      if (!csvData) return alert("ã¾ãšCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");

      document.getElementById('commentBox').innerText = "ChatGPTã«ã‚ˆã‚‹åˆ†æã‚’ç”Ÿæˆä¸­...";

      fetch('http://localhost:5000/get_comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csv: csvData })
      })
      .then(res => res.json())
      .then(data => {
        if (data.comment) {
          document.getElementById('commentBox').innerText = "ğŸ’¬ ChatGPTã«ã‚ˆã‚‹åˆ†æçµæœï¼š\n" + data.comment;
        } else {
          document.getElementById('commentBox').innerText = "âš ï¸ ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
        }
      })
      .catch(err => {
        document.getElementById('commentBox').innerText = "âš ï¸ ã‚¨ãƒ©ãƒ¼ï¼š" + err;
      });
    });
  </script>
</body>
</html>
