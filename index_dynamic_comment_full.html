<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <title>ğŸ“Š CSVæ”¯å‡ºåˆ†æåœ–è¡¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 50px;
      background: #f5f5f5;
    }
    input, button {
      margin: 10px;
    }
    canvas {
      max-width: 600px;
      margin: auto;
    }
    #commentBox {
      margin-top: 40px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <h1>ğŸ“Š å¾CSVæª”æ¡ˆç”Ÿæˆæ”¯å‡ºåˆ†æåœ–è¡¨</h1>
  
  <p>è«‹ä¸Šå‚³åŒ…å«ä»¥ä¸‹æ¬„ä½çš„CSVæª”æ¡ˆï¼šday, time, name, cost, genre</p>
  <input accept=".csv" id="csvFile" type="file"/>
  <br/>
  <!-- ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸‹ãªã©ã«è¿½åŠ å¯èƒ½ -->
  <div class="section">
    <a href="makedata.html">
      <button>ğŸ“„ ãƒ‡ãƒ¼ã‚¿ä½œæˆç”»é¢ã¸</button>
    </a>
  </div>

  <button id="generateBtn">ğŸ“ˆ ç”Ÿæˆåœ–è¡¨</button>
  <button id="generateCommentBtn">ğŸ’¬ ç”Ÿæˆ ChatGPT åˆ†æè©•è«–</button>

  <div class="section">
    <h2>ğŸ° å„é¡æ”¯å‡ºåœ“é¤…åœ–ï¼ˆå…ƒï¼‰</h2>
    <canvas id="pieChart" width="400" height="400"></canvas>
  </div>

  <div class="section">
    <h2>ğŸ“… æ¯æ—¥å¹³å‡æ”¯å‡ºé‡‘é¡</h2>
    <p id="avgCost">-</p>
  </div>

  <div class="section">
    <h2>ğŸ† æ”¯å‡ºé¡åˆ¥æ’è¡Œæ¦œ</h2>
    <ul id="rankingList"></ul>
  </div>

  <div class="section">
    <h2>ğŸ“ˆ æ¯æœˆæ”¯å‡ºè¶¨å‹¢</h2>
    <canvas id="lineChart" width="600" height="400"></canvas>
  </div>

  <div id="commentBox">ğŸ’¬ å°šæœªç”Ÿæˆè©•è«–</div>

  <script>
    let csvData = "";

    document.getElementById('csvFile').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return alert("è«‹é¸æ“‡CSVæª”æ¡ˆ");

      const reader = new FileReader();
      reader.onload = function (event) {
        csvData = event.target.result.trim();
      };
      reader.readAsText(file, 'UTF-8');
    });

    document.getElementById('generateBtn').addEventListener('click', function () {
      if (!csvData) return alert("è«‹å…ˆä¸Šå‚³CSVæª”æ¡ˆ");

      const lines = csvData.split('\n');
      const headers = lines[0].split(',');

      const genreIndex = headers.indexOf('genre');
      const costIndex = headers.indexOf('cost');
      const dayIndex = headers.indexOf('day');
      if (genreIndex === -1 || costIndex === -1 || dayIndex === -1) {
        return alert("CSVæª”æ¡ˆéœ€åŒ…å« 'day', 'genre', 'cost' æ¬„ä½");
      }

      const dataMap = {};
      const dayTotal = {};
      const genreTotal = {};
      const monthTotal = {};

      for (let i = 1; i < lines.length; i++) {
        const row = lines[i].split(',');
        const genre = row[genreIndex];
        const cost = parseFloat(row[costIndex]);
        const day = row[dayIndex];
        const month = day?.slice(0, 7);
        if (!isNaN(cost) && genre && day) {
          dataMap[genre] = (dataMap[genre] || 0) + cost;
          genreTotal[genre] = (genreTotal[genre] || 0) + cost;
          dayTotal[day] = (dayTotal[day] || 0) + cost;
          monthTotal[month] = (monthTotal[month] || 0) + cost;
        }
      }

      // åœ“é¤…åœ–
      const sortedEntries = Object.entries(dataMap).sort((a, b) => b[1] - a[1]);
      const labels = sortedEntries.map(entry => entry[0]);
      const values = sortedEntries.map(entry => entry[1]);
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (window.pieChart && typeof window.pieChart.destroy === 'function') window.pieChart.destroy();
      window.pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['red','blue','green','orange','purple','pink','brown','yellow','gray','cyan']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            title: { display: true, text: 'æ”¯å‡ºåœ“é¤…åœ–ï¼ˆä¾é‡‘é¡æ’åºï¼‰' }
          }
        }
      });

      // å¹³å‡æ¯æ—¥æ”¯å‡º
      const totalDays = Object.keys(dayTotal).length;
      const totalCost = Object.values(dayTotal).reduce((a, b) => a + b, 0);
      const avg = totalDays > 0 ? (totalCost / totalDays).toFixed(2) : "0";
      document.getElementById("avgCost").innerText = `å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š${avg} å…ƒ`;

      // é¡åˆ¥æ”¯å‡ºæ’è¡Œæ¦œ
      const sortedGenre = Object.entries(genreTotal).sort((a, b) => b[1] - a[1]);
      const rankList = document.getElementById("rankingList");
      rankList.innerHTML = "";
      sortedGenre.forEach(([genre, amount], idx) => {
        const li = document.createElement("li");
        li.textContent = `${idx + 1}ï¼š${genre} - ${Math.round(amount)} å…ƒ`;
        rankList.appendChild(li);
      });

      // æœˆåˆ¥æ”¯å‡ºæŠ˜ç·šåœ–
      const sortedMonths = Object.keys(monthTotal).sort();
      const monthValues = sortedMonths.map(m => monthTotal[m]);
      const lineCtx = document.getElementById("lineChart").getContext("2d");
      if (window.lineChart && typeof window.lineChart.destroy === 'function') window.lineChart.destroy();
      window.lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'æ¯æœˆæ”¯å‡ºï¼ˆå…ƒï¼‰',
            data: monthValues,
            fill: false,
            borderColor: 'blue',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: 'æ¯æœˆæ”¯å‡ºè¶¨å‹¢åœ–' }
          }
        }
      });
    });

    document.getElementById('generateCommentBtn').addEventListener('click', function () {
      if (!csvData) return alert("è«‹å…ˆä¸Šå‚³CSVæª”æ¡ˆ");

      document.getElementById('commentBox').innerText = "æ­£åœ¨ç”Ÿæˆ ChatGPT åˆ†æ...";

      fetch('http://localhost:5000/get_comment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ csv: csvData })
      })
      .then(res => res.json())
      .then(data => {
        if (data.comment) {
          document.getElementById('commentBox').innerText = "ğŸ’¬ ChatGPT åˆ†æçµæœï¼š\n" + data.comment;
        } else {
          document.getElementById('commentBox').innerText = "âš ï¸ ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
      })
      .catch(err => {
        document.getElementById('commentBox').innerText = "âš ï¸ éŒ¯èª¤ï¼š" + err;
      });
    });
  </script>
</body>
</html>
